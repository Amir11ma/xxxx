<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯ÙˆØ² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
<link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary-color: #4CAF50;
    --secondary-color: #ff9800;
    --accent-color: #2196F3;
    --win-color: #FFD700;
    --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-bg: rgba(255, 255, 255, 0.95);
    --text-dark: #333;
    --text-light: #fff;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Vazir', Tahoma, sans-serif;
}

body {
    background: var(--bg-gradient);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 15px;
    direction: rtl;
}

.container {
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-width: 1200px;
    padding: 20px;
    gap: 20px;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ø± Ùˆ Ù„ÙˆÚ¯Ùˆ */
.header {
    text-align: center;
    margin-bottom: 20px;
}

.logo {
    font-size: 3rem;
    margin-bottom: 10px;
    color: var(--win-color);
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

h1 {
    color: var(--text-light);
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    margin-bottom: 15px;
    text-align: center;
    font-size: clamp(24px, 5vw, 32px);
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ */
input {
    padding: 12px 15px;
    font-size: 16px;
    border-radius: 12px;
    border: 2px solid var(--primary-color);
    margin-bottom: 20px;
    width: 90%;
    max-width: 350px;
    text-align: center;
    background: var(--card-bg);
    transition: all 0.3s ease;
}

input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
}

button {
    margin: 8px;
    padding: 15px 25px;
    font-size: 16px;
    border: none;
    border-radius: 15px;
    background: linear-gradient(45deg, var(--primary-color), #45a049);
    color: var(--text-light);
    width: 90%;
    max-width: 350px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    font-weight: bold;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

button:active {
    transform: translateY(0);
}

button.secondary {
    background: linear-gradient(45deg, var(--secondary-color), #f57c00);
}

button.tertiary {
    background: linear-gradient(45deg, var(--accent-color), #1976D2);
}

button.danger {
    background: linear-gradient(45deg, #f44336, #d32f2f);
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ®ØªÙ‡ Ø¨Ø§Ø²ÛŒ */
.board-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
}

#board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 10px;
    margin: 0 auto;
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 20px;
    max-width: 400px;
    width: 100%;
    aspect-ratio: 1;
}

.cell {
    display: flex;
    justify-content: center;
    align-items: center;
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(30px, 8vw, 50px);
    font-weight: bold;
    aspect-ratio: 1;
}

.cell:hover {
    transform: scale(1.05);
    background: #e8f5e8;
}

.cell.winning-cell {
    background: linear-gradient(45deg, var(--win-color), #FFA500);
    color: var(--text-light);
    animation: glow 0.6s ease-in-out infinite alternate;
}

@keyframes glow {
    from { box-shadow: 0 0 10px var(--win-color); }
    to { box-shadow: 0 0 20px #FFA500; }
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
#turnMsg {
    font-size: clamp(18px, 4vw, 22px);
    margin: 15px;
    color: var(--text-light);
    font-weight: bold;
    text-align: center;
    background: rgba(255,255,255,0.2);
    padding: 12px 25px;
    border-radius: 25px;
    backdrop-filter: blur(10px);
}

#resultOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    color: var(--text-light);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(10px);
}

.result-content {
    background: var(--card-bg);
    color: var(--text-dark);
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 90%;
    width: 400px;
    border: 3px solid var(--win-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

#resultText {
    font-size: clamp(24px, 5vw, 32px);
    margin-bottom: 15px;
    color: var(--primary-color);
    font-weight: bold;
}

.win-explanation {
    font-size: clamp(16px, 4vw, 20px);
    margin: 15px 0;
    color: var(--accent-color);
    font-weight: bold;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
.leaderboard, .profile-section, .stats-card {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 25px;
    margin: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.leaderboard h2, .profile-section h2 {
    color: var(--primary-color);
    text-align: center;
    margin-bottom: 20px;
    font-size: clamp(20px, 4vw, 24px);
}

.leaderboard-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 2px solid #f0f0f0;
    transition: background 0.3s ease;
}

.leaderboard-item:hover {
    background: #f8f8f8;
    border-radius: 8px;
}

.leaderboard-item:last-child {
    border-bottom: none;
}

.player-name {
    font-weight: bold;
    color: var(--text-dark);
    font-size: 16px;
}

.player-score {
    color: var(--primary-color);
    font-weight: bold;
    font-size: 18px;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ */
.profile-header {
    text-align: center;
    margin-bottom: 20px;
}

.profile-name {
    font-size: clamp(20px, 4vw, 24px);
    color: var(--text-dark);
    margin-bottom: 10px;
}

.profile-trophy {
    font-size: 3rem;
    color: var(--win-color);
    margin-bottom: 15px;
}

.skill-level {
    background: linear-gradient(45deg, var(--primary-color), #45a049);
    color: var(--text-light);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 16px;
    margin-bottom: 20px;
    display: inline-block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-item {
    background: #f8f8f8;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    transition: transform 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-3px);
}

.stat-value {
    font-size: clamp(20px, 4vw, 24px);
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: #666;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ */
.history-item {
    background: #f8f8f8;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    border-right: 4px solid var(--primary-color);
    transition: transform 0.3s ease;
}

.history-item:hover {
    transform: translateX(-5px);
}

.history-win {
    border-right-color: var(--primary-color);
}

.history-loss {
    border-right-color: #f44336;
}

.history-draw {
    border-right-color: var(--secondary-color);
}

.rank-badge {
    background: linear-gradient(45deg, var(--win-color), #FFA500);
    color: var(--text-light);
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 14px;
    font-weight: bold;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ */
.game-controls {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.game-controls button {
    width: auto;
    min-width: 140px;
    margin: 5px;
    flex: 1;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ùˆ */
.menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    width: 100%;
    max-width: 800px;
}

.menu-card {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    cursor: pointer;
}

.menu-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}

.menu-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    color: var(--accent-color);
}

.menu-title {
    font-size: 20px;
    color: var(--text-dark);
    margin-bottom: 10px;
    font-weight: bold;
}

.menu-description {
    font-size: 14px;
    color: #666;
    line-height: 1.5;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .menu-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .game-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .game-controls button {
        width: 90%;
    }
    
    #board {
        padding: 15px;
        grid-gap: 8px;
    }
    
    .cell {
        border-radius: 12px;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .leaderboard, .profile-section, .stats-card {
        padding: 15px;
        margin: 10px;
    }
    
    button {
        padding: 12px 20px;
        font-size: 14px;
    }
    
    .menu-card {
        padding: 20px;
    }
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.container {
    animation: slideIn 0.5s ease-out;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØª */
.progress-bar {
    width: 100%;
    height: 10px;
    background: #f0f0f0;
    border-radius: 5px;
    margin: 10px 0;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
    border-radius: 5px;
    transition: width 0.5s ease;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ§ÛŒÙ…Ø± */
.timer {
    font-size: 14px;
    color: var(--text-light);
    background: rgba(0,0,0,0.3);
    padding: 5px 10px;
    border-radius: 15px;
    margin-top: 10px;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø­Ø§Ù„Øª Ø´Ø¨ */
body.night-mode {
    --bg-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    --card-bg: rgba(44, 62, 80, 0.95);
    --text-dark: #ecf0f1;
    --text-light: #ecf0f1;
}

.theme-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    background: var(--card-bg);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
}

/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©Ù„ØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}
</style>
</head>
<body>

<!-- Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± ØªÙ… -->
<button class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-moon"></i>
</button>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø³Ù… -->
<div id="lobby" class="container" style="display:flex;">
    <div class="header">
        <div class="logo">ğŸ¯</div>
        <h1>Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h1>
    </div>
    <input type="text" id="playerName" placeholder="Ø§Ø³Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" onkeypress="handleEnterKey(event)">
    <button onclick="showGameOptions()">
        <i class="fas fa-play"></i> Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
    </button>
</div>

<!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù…Ù†Ùˆ -->
<div id="mainMenu" class="container">
    <div class="header">
        <div class="logo">ğŸŒŸ</div>
        <h1>Ø¨Ù‡ Ø¯ÙˆØ² Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h1>
    </div>
    <div class="menu-grid">
        <div class="menu-card" onclick="showGameOptions()">
            <div class="menu-icon"><i class="fas fa-gamepad"></i></div>
            <div class="menu-title">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</div>
            <div class="menu-description">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª ÛŒØ§ Ø¯Ùˆ Ù†ÙØ±Ù‡</div>
        </div>
        <div class="menu-card" onclick="showProfile()">
            <div class="menu-icon"><i class="fas fa-user"></i></div>
            <div class="menu-title">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†</div>
            <div class="menu-description">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø± Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§</div>
        </div>
        <div class="menu-card" onclick="showLeaderboard()">
            <div class="menu-icon"><i class="fas fa-trophy"></i></div>
            <div class="menu-title">Ø¬Ø¯ÙˆÙ„ Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§</div>
            <div class="menu-description">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</div>
        </div>
        <div class="menu-card" onclick="showSettings()">
            <div class="menu-icon"><i class="fas fa-cog"></i></div>
            <div class="menu-title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
            <div class="menu-description">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡</div>
        </div>
    </div>
</div>

<!-- ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¨Ø§Ø²ÛŒ -->
<div id="gameOptions" class="container">
    <div class="header">
        <h1>ğŸ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</h1>
    </div>
    <div class="menu-grid">
        <div class="menu-card" onclick="startSinglePlayer()">
            <div class="menu-icon"><i class="fas fa-robot"></i></div>
            <div class="menu-title">Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª</div>
            <div class="menu-description">Ø­Ø±ÛŒÙ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ Ø³Ø·ÙˆØ­ Ù…Ø®ØªÙ„Ù</div>
        </div>
        <div class="menu-card" onclick="startTwoPlayers()">
            <div class="menu-icon"><i class="fas fa-users"></i></div>
            <div class="menu-title">Ø¨Ø§Ø²ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡</div>
            <div class="menu-description">Ø±ÙˆÛŒ ÛŒÚ© Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù† Ø¨Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯</div>
        </div>
    </div>
    <button onclick="showMainMenu()" class="secondary">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ
    </button>
</div>

<!-- ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
<div id="profile" class="container">
    <div class="profile-section">
        <div class="profile-header">
            <div class="profile-trophy">ğŸ†</div>
            <div class="profile-name" id="profileName">...</div>
            <div class="skill-level" id="skillLevel">Ù…Ù‡Ø§Ø±Øª: Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</div>
            <div class="rank-badge" id="rankBadge">Ø±ØªØ¨Ù‡: -</div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="winRate">0%</div>
                <div class="stat-label">Ø¯Ø±ØµØ¯ Ø¨Ø±Ø¯</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalGames">0</div>
                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="skillPercent">0%</div>
                <div class="stat-label">Ù…Ù‡Ø§Ø±Øª Ú©Ù„ÛŒ</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="skillProgress"></div>
                </div>
            </div>
        </div>
        
        <h3><i class="fas fa-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§</h3>
        <div id="gameHistory"></div>
    </div>
    <button onclick="showMainMenu()" class="secondary">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ
    </button>
</div>

<!-- ØµÙØ­Ù‡ Ø¬Ø¯ÙˆÙ„ Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ -->
<div id="leaderboard" class="container">
    <div class="header">
        <h1>ğŸ† Ø¬Ø¯ÙˆÙ„ Ø¨Ø±ØªØ±ÛŒÙ† Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h1>
    </div>
    <div class="leaderboard">
        <h2><i class="fas fa-robot"></i> Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø¨Ø§Øª</h2>
        <div id="singleLeaderboard"></div>
    </div>
    <button onclick="showMainMenu()" class="secondary">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ
    </button>
</div>

<!-- ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
<div id="settings" class="container">
    <div class="profile-section">
        <h2><i class="fas fa-cog"></i> ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø²ÛŒ</h2>
        
        <div class="setting-item">
            <label>Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ Ø±Ø¨Ø§Øª:</label>
            <select id="difficulty" onchange="changeDifficulty()">
                <option value="easy">Ø¢Ø³Ø§Ù†</option>
                <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                <option value="hard">Ø³Ø®Øª</option>
            </select>
        </div>
        
        <div class="setting-item">
            <label>Ù†Ù…Ø§ÛŒØ´ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†:</label>
            <input type="checkbox" id="animations" checked onchange="toggleAnimations()">
        </div>
        
        <div class="setting-item">
            <label>ØµØ¯Ø§ÛŒ Ø¨Ø§Ø²ÛŒ:</label>
            <input type="checkbox" id="sound" checked onchange="toggleSound()">
        </div>
        
        <div class="setting-item">
            <label>ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†:</label>
            <input type="text" id="newPlayerName" placeholder="Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯">
            <button onclick="changePlayerName()" class="tertiary">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
        </div>
        
        <button onclick="resetStats()" class="danger">
            <i class="fas fa-trash"></i> Ø±ÛŒØ³Øª Ø¢Ù…Ø§Ø±
        </button>
    </div>
    <button onclick="showMainMenu()" class="secondary">
        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ
    </button>
</div>

<!-- ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ -->
<div id="game" class="container">
    <div class="board-container">
        <h1 id="gameTitle">ØªØ®ØªÙ‡ Ø¯ÙˆØ²</h1>
        <div id="turnMsg"></div>
        <div id="board"></div>
        <div class="game-info">
            <div class="timer" id="gameTimer">Ø²Ù…Ø§Ù†: 00:00</div>
        </div>
        <div class="game-controls">
            <button onclick="showGameOptions()" class="secondary">
                <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
            </button>
            <button onclick="restartSameGame()" class="tertiary">
                <i class="fas fa-redo"></i> Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯
            </button>
        </div>
    </div>
</div>

<!-- overlay Ù†ØªÛŒØ¬Ù‡ Ø¨Ø§Ø²ÛŒ -->
<div id="resultOverlay">
    <div class="result-content">
        <div id="resultText"></div>
        <div id="winExplanation" class="win-explanation"></div>
        <div class="game-controls">
            <button onclick="restartSameGame()">
                <i class="fas fa-redo"></i> Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯
            </button>
            <button onclick="showGameOptions()" class="secondary">
                <i class="fas fa-gamepad"></i> Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
            </button>
            <button onclick="showMainMenu()" class="tertiary">
                <i class="fas fa-home"></i> Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
            </button>
        </div>
    </div>
</div>

<script>
// ====== Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ ======
let player = {
    name: "",
    symbol: "",
    points: 0,
    games: {
        single: { wins: 0, losses: 0, draws: 0, total: 0 },
        twoPlayer: { wins: 0, losses: 0, draws: 0, total: 0 }
    },
    history: [],
    settings: {
        difficulty: "medium",
        animations: true,
        sound: true
    }
};

let board = ["","","","","","","","",""];
let myTurn = false;
let gameMode = "";
let currentSymbol = "X";
let winningCombination = [];
let gameActive = true;
let gameStartTime = 0;
let gameTimer = null;
let resultTimeout = null;

// ====== Ø¬Ø¯ÙˆÙ„ Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ ======
let leaderboards = {
    single: JSON.parse(localStorage.getItem('singleLeaderboard')) || []
};

// ====== ØªÙˆØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ø§Øª ======
function showPage(id){ 
    document.querySelectorAll('.container').forEach(c=>c.style.display='none'); 
    document.getElementById(id).style.display='flex'; 
}

function handleEnterKey(event) {
    if (event.key === 'Enter') {
        showGameOptions();
    }
}

function showGameOptions(){ 
    const name = document.getElementById('playerName').value.trim();
    if(!name) {
        alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        return;
    }
    player.name = name;
    localStorage.setItem('playerName', name);
    savePlayerData();
    showPage('gameOptions');
}

function showMainMenu() {
    // Ù„ØºÙˆ ØªØ§ÛŒÙ…Ø± Ù†ØªÛŒØ¬Ù‡ Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
    if(resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
    }
    document.getElementById('resultOverlay').style.display = 'none';
    showPage('mainMenu');
}

function showProfile() {
    if(resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
    }
    document.getElementById('resultOverlay').style.display = 'none';
    updateProfileDisplay();
    showPage('profile');
}

function showLeaderboard() {
    if(resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
    }
    document.getElementById('resultOverlay').style.display = 'none';
    updateLeaderboardDisplay();
    showPage('leaderboard');
}

function showSettings() {
    if(resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
    }
    document.getElementById('resultOverlay').style.display = 'none';
    loadSettings();
    showPage('settings');
}

// ====== Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª ======
function loadSettings() {
    document.getElementById('difficulty').value = player.settings.difficulty;
    document.getElementById('animations').checked = player.settings.animations;
    document.getElementById('sound').checked = player.settings.sound;
    document.getElementById('newPlayerName').value = player.name;
}

function changeDifficulty() {
    player.settings.difficulty = document.getElementById('difficulty').value;
    savePlayerData();
}

function toggleAnimations() {
    player.settings.animations = document.getElementById('animations').checked;
    savePlayerData();
}

function toggleSound() {
    player.settings.sound = document.getElementById('sound').checked;
    savePlayerData();
}

function changePlayerName() {
    const newName = document.getElementById('newPlayerName').value.trim();
    if(newName && newName !== player.name) {
        player.name = newName;
        localStorage.setItem('playerName', newName);
        savePlayerData();
        alert("Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯");
    }
}

function resetStats() {
    if(confirm("Ø¢ÛŒØ§ Ø§Ø² Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø¢Ù…Ø§Ø± Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§Ø²ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) {
        player.points = 0;
        player.games = {
            single: { wins: 0, losses: 0, draws: 0, total: 0 },
            twoPlayer: { wins: 0, losses: 0, draws: 0, total: 0 }
        };
        player.history = [];
        savePlayerData();
        updateProfileDisplay();
        alert("Ø¢Ù…Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±ÛŒØ³Øª Ø´Ø¯");
    }
}

function toggleTheme() {
    document.body.classList.toggle('night-mode');
    const icon = document.querySelector('.theme-toggle i');
    if(document.body.classList.contains('night-mode')) {
        icon.className = 'fas fa-sun';
    } else {
        icon.className = 'fas fa-moon';
    }
}

// ====== Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§ÛŒÙ…Ø± Ø¨Ø§Ø²ÛŒ ======
function startGameTimer() {
    gameStartTime = Date.now();
    clearInterval(gameTimer);
    gameTimer = setInterval(updateGameTimer, 1000);
}

function updateGameTimer() {
    if (!gameActive) return;
    
    const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    document.getElementById('gameTimer').textContent = `Ø²Ù…Ø§Ù†: ${minutes}:${seconds}`;
}

function stopGameTimer() {
    clearInterval(gameTimer);
}

// ====== Ø³Ø§Ø®Øª ØªØ®ØªÙ‡ ======
function createBoard(){ 
    const boardDiv = document.getElementById('board'); 
    boardDiv.innerHTML="";
    for(let i=0;i<9;i++){ 
        const cell = document.createElement('div'); 
        cell.className="cell"; 
        cell.id=i; 
        cell.addEventListener('click',()=>cellClick(i)); 
        boardDiv.appendChild(cell); 
    }
    document.getElementById('resultOverlay').style.display = 'none';
    gameActive = true;
}

function updateBoard(){ 
    // Ø­Ø°Ù Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø§Ø² Ù‡Ù…Ù‡ Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§
    document.querySelectorAll('.cell').forEach(cell => {
        cell.classList.remove('winning-cell');
    });
    
    // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ±
    board.forEach((v,i)=>{ 
        const cell=document.getElementById(i); 
        if(cell) {
            cell.textContent = v === "X" ? "âŒ" : v === "O" ? "â­•" : "";
        }
    });
    
    // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù†Ø¯Ù‡
    if(player.settings.animations) {
        winningCombination.forEach(index => {
            const cell = document.getElementById(index);
            if(cell) {
                cell.classList.add('winning-cell');
            }
        });
    }
}

// ====== Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ù†Ø¯Ù‡ ======
function checkWinner(boardState){
    const winComb=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    
    for(let c of winComb){ 
        if(boardState[c[0]] && boardState[c[0]]===boardState[c[1]] && boardState[c[0]]===boardState[c[2]]) {
            winningCombination = c;
            return {
                winner: boardState[c[0]],
                combination: c,
                type: getWinType(c)
            };
        }
    }
    
    if(!boardState.includes("")) {
        winningCombination = [];
        return {
            winner: "draw",
            combination: [],
            type: "Ù…Ø³Ø§ÙˆÛŒ"
        };
    }
    
    winningCombination = [];
    return null;
}

function getWinType(combination) {
    // ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ø®Ø· Ø¨Ø±Ù†Ø¯Ù‡
    if(combination[0] === 0 && combination[2] === 2) return "Ø®Ø· Ø§ÙÙ‚ÛŒ Ø¨Ø§Ù„Ø§";
    if(combination[0] === 3 && combination[2] === 5) return "Ø®Ø· Ø§ÙÙ‚ÛŒ ÙˆØ³Ø·";
    if(combination[0] === 6 && combination[2] === 8) return "Ø®Ø· Ø§ÙÙ‚ÛŒ Ù¾Ø§ÛŒÛŒÙ†";
    if(combination[0] === 0 && combination[2] === 6) return "Ø®Ø· Ø¹Ù…ÙˆØ¯ÛŒ Ú†Ù¾";
    if(combination[0] === 1 && combination[2] === 7) return "Ø®Ø· Ø¹Ù…ÙˆØ¯ÛŒ ÙˆØ³Ø·";
    if(combination[0] === 2 && combination[2] === 8) return "Ø®Ø· Ø¹Ù…ÙˆØ¯ÛŒ Ø±Ø§Ø³Øª";
    if(combination[0] === 0 && combination[2] === 8) return "Ø®Ø· Ù…ÙˆØ±Ø¨ Ø§ØµÙ„ÛŒ (\\\\)";
    if(combination[0] === 2 && combination[2] === 6) return "Ø®Ø· Ù…ÙˆØ±Ø¨ ÙØ±Ø¹ÛŒ (//)";
    return "Ø®Ø· Ø¨Ø±Ù†Ø¯Ù‡";
}

// ====== Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ ======
function handleWinner(result){
    gameActive = false;
    stopGameTimer();
    
    // Ù†Ù…Ø§ÛŒØ´ Ø®Ø· Ø¨Ø±Ù†Ø¯Ù‡
    winningCombination = result.combination;
    updateBoard();
    
    let resultText = "";
    let pointsChange = 0;
    let historyEntry = "";
    let winExplanation = "";

    if(result.winner !== "draw"){
        if(gameMode === "single") {
            if(result.winner === player.symbol) {
                resultText = "ğŸ‰ Ø´Ù…Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯!";
                pointsChange = 3;
                player.games.single.wins++;
                historyEntry = `Ø¨Ø±Ø¯ Ø§Ø² Ø±Ø¨Ø§Øª (+${pointsChange} Ø§Ù…ØªÛŒØ§Ø²)`;
                winExplanation = `Ø´Ù…Ø§ Ø¨Ø§ ${result.type} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯!`;
                playSound('win');
            } else {
                resultText = "ğŸ¤– Ø±Ø¨Ø§Øª Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!";
                pointsChange = -5;
                player.games.single.losses++;
                historyEntry = `Ø¨Ø§Ø®Øª Ø¨Ù‡ Ø±Ø¨Ø§Øª (${pointsChange} Ø§Ù…ØªÛŒØ§Ø²)`;
                winExplanation = `Ø±Ø¨Ø§Øª Ø¨Ø§ ${result.type} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!`;
                playSound('lose');
            }
        } else if(gameMode === "two") {
            resultText = `ğŸ¯ Ø¨Ø§Ø²ÛŒÚ©Ù† ${result.winner} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!`;
            historyEntry = `Ø¨Ø§Ø²ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡ - Ø¨Ø±Ù†Ø¯Ù‡: ${result.winner}`;
            winExplanation = `Ø¨Ø§Ø²ÛŒÚ©Ù† ${result.winner} Ø¨Ø§ ${result.type} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!`;
            playSound('win');
        }
    } else {
        resultText = "ğŸ¤ Ø¨Ø§Ø²ÛŒ Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!";
        if(gameMode === "single") {
            pointsChange = 1;
            player.games.single.draws++;
            historyEntry = `Ù…Ø³Ø§ÙˆÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª (+${pointsChange} Ø§Ù…ØªÛŒØ§Ø²)`;
            winExplanation = "Ù‡ÛŒÚ†Ú©Ø³ Ù†ØªÙˆØ§Ù†Ø³Øª Ø®Ø· Ú©Ø§Ù…Ù„ Ú©Ù†Ø¯!";
        } else {
            player.games.twoPlayer.draws++;
            historyEntry = `Ø¨Ø§Ø²ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡ - Ù…Ø³Ø§ÙˆÛŒ`;
            winExplanation = "Ù‡ÛŒÚ†Ú©Ø³ Ù†ØªÙˆØ§Ù†Ø³Øª Ø®Ø· Ú©Ø§Ù…Ù„ Ú©Ù†Ø¯!";
        }
        playSound('draw');
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²
    player.points = Math.max(0, player.points + pointsChange);
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
    if(historyEntry) {
        const gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
        player.history.unshift({
            text: historyEntry,
            type: result.winner === player.symbol ? 'win' : 
                  result.winner === "draw" ? 'draw' : 'loss',
            timestamp: new Date().toLocaleDateString('fa-IR'),
            explanation: winExplanation,
            time: gameTime
        });
        
        player.history = player.history.slice(0, 10);
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ûµ Ø«Ø§Ù†ÛŒÙ‡
    resultTimeout = setTimeout(() => {
        showGameResult(resultText, winExplanation);
    }, 5000);
    
    savePlayerData();
}

// ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ø¨Ø§Ø²ÛŒ
function showGameResult(resultText, winExplanation) {
    document.getElementById('resultText').textContent = resultText;
    document.getElementById('winExplanation').textContent = winExplanation;
    document.getElementById('resultOverlay').style.display = 'flex';
    
    // ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² Û±Û° Ø«Ø§Ù†ÛŒÙ‡
    setTimeout(() => {
        if(document.getElementById('resultOverlay').style.display === 'flex') {
            restartSameGame(); // Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯
        }
    }, 10000);
}

// ====== Ù…Ø¯ÛŒØ±ÛŒØª ØµØ¯Ø§ ======
function playSound(type) {
    if(!player.settings.sound) return;
    
    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØµØ¯Ø§ Ø¨Ø§ Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        switch(type) {
            case 'win':
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                break;
            case 'lose':
                oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime); // F4
                break;
            case 'draw':
                oscillator.frequency.setValueAtTime(440.00, audioContext.currentTime); // A4
                break;
            case 'move':
                oscillator.frequency.setValueAtTime(261.63, audioContext.currentTime); // C4
                break;
        }
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯');
    }
}

// ====== Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† ======
function savePlayerData() {
    localStorage.setItem('playerData', JSON.stringify(player));
    localStorage.setItem('singleLeaderboard', JSON.stringify(leaderboards.single));
}

function loadPlayerData() {
    const savedData = localStorage.getItem('playerData');
    if(savedData) {
        const data = JSON.parse(savedData);
        player = {...player, ...data};
    }
}

function updateProfileDisplay() {
    document.getElementById('profileName').textContent = player.name;
    document.getElementById('totalPoints').textContent = player.points;
    document.getElementById('totalGames').textContent = player.games.single.total + player.games.twoPlayer.total;
    
    const totalWins = player.games.single.wins + player.games.twoPlayer.wins;
    const totalGames = player.games.single.total + player.games.twoPlayer.total;
    const winRate = totalGames > 0 ? Math.round((totalWins / totalGames) * 100) : 0;
    document.getElementById('winRate').textContent = winRate + '%';
    
    const skillPercent = calculateSkillPercentage();
    document.getElementById('skillPercent').textContent = skillPercent + '%';
    document.getElementById('skillProgress').style.width = skillPercent + '%';
    document.getElementById('skillLevel').textContent = `Ù…Ù‡Ø§Ø±Øª: ${getSkillLevel(skillPercent)}`;
    
    updateRankBadge();
    updateGameHistory();
}

function calculateSkillPercentage() {
    const totalGames = player.games.single.total;
    if(totalGames === 0) return 0;
    
    const winRate = (player.games.single.wins / totalGames) * 100;
    const drawRate = (player.games.single.draws / totalGames) * 50;
    
    return Math.min(100, Math.round(winRate + drawRate));
}

function getSkillLevel(percent) {
    if(percent >= 90) return "Ø§Ø³ØªØ§Ø¯ Ø¯ÙˆØ² ğŸ†";
    if(percent >= 75) return "Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â­";
    if(percent >= 60) return "Ù…ØªÙˆØ³Ø· ğŸ‘";
    if(percent >= 40) return "Ù…Ø¨ØªØ¯ÛŒ ğŸŒ±";
    return "ØªØ§Ø²Ù‡â€ŒÚ©Ø§Ø± ğŸ¯";
}

function updateRankBadge() {
    const rank = calculateRank();
    document.getElementById('rankBadge').textContent = `Ø±ØªØ¨Ù‡: ${rank}`;
}

function calculateRank() {
    const points = player.points;
    if(points >= 100) return "Ø·Ù„Ø§ÛŒÛŒ ğŸ¥‡";
    if(points >= 50) return "Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ ğŸ¥ˆ";
    if(points >= 20) return "Ø¨Ø±Ù†Ø²ÛŒ ğŸ¥‰";
    return "Ø¬Ø¯ÛŒØ¯ ğŸ¯";
}

function updateGameHistory() {
    const historyDiv = document.getElementById('gameHistory');
    historyDiv.innerHTML = player.history.map((game, index) => `
        <div class="history-item history-${game.type}">
            <div><strong>${game.text}</strong></div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">${game.explanation}</div>
            <div style="font-size: 11px; color: #888; margin-top: 3px;">Ø²Ù…Ø§Ù†: ${game.time} Ø«Ø§Ù†ÛŒÙ‡</div>
            <small>${game.timestamp}</small>
        </div>
    `).join('') || '<div style="text-align:center; color:#666; padding:20px;">Ù‡Ù†ÙˆØ² Ø¨Ø§Ø²ÛŒâ€ŒØ§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯</div>';
}

// ====== Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ ======
function updateLeaderboard() {
    let leaderboard = leaderboards.single;
    let existingPlayer = leaderboard.find(p => p.name === player.name);
    
    if(existingPlayer) {
        existingPlayer.score = player.points;
    } else {
        leaderboard.push({name: player.name, score: player.points});
    }
    
    leaderboard.sort((a, b) => b.score - a.score);
    savePlayerData();
}

function updateLeaderboardDisplay() {
    const singleLB = document.getElementById('singleLeaderboard');
    singleLB.innerHTML = leaderboards.single.slice(0, 10).map((player, index) => `
        <div class="leaderboard-item">
            <span class="player-name">
                ${index < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][index] : (index + 1 + '.')} 
                ${player.name}
            </span>
            <span class="player-score">${player.score} ğŸ†</span>
        </div>
    `).join('') || '<div style="text-align:center; color:#666; padding:20px;">Ù‡Ù†ÙˆØ² Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
}

// ====== Ø¨Ø§Ø²ÛŒ ØªÚ© Ù†ÙØ±Ù‡ Ø¨Ø§ Ø±Ø¨Ø§Øª ======
function startSinglePlayer(){
    // Ù„ØºÙˆ ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    if(resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
    }
    
    gameMode="single";
    player.symbol="X"; 
    myTurn=true;
    board=["","","","","","","","",""];
    winningCombination = [];
    player.games.single.total++;
    
    document.getElementById('gameTitle').textContent = "Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª";
    showPage('game');
    createBoard();
    updateBoard();
    document.getElementById('turnMsg').textContent = "Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª! (Ø´Ù…Ø§ âŒ Ù‡Ø³ØªÛŒØ¯)";
    startGameTimer();
}

// ====== Ø¨Ø§Ø²ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡ ======
function startTwoPlayers(){
    // Ù„ØºÙˆ ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    if(resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
    }
    
    gameMode="two";
    currentSymbol="X";
    board=["","","","","","","","",""];
    winningCombination = [];
    player.games.twoPlayer.total++;
    
    document.getElementById('gameTitle').textContent = "Ø¨Ø§Ø²ÛŒ Ø¯Ùˆ Ù†ÙØ±Ù‡";
    showPage('game');
    createBoard();
    updateBoard();
    document.getElementById('turnMsg').textContent = `Ù†ÙˆØ¨Øª Ø¨Ø§Ø²ÛŒÚ©Ù† âŒ`;
    startGameTimer();
}

// ====== ØªØ¹Ø§Ù…Ù„ Ø¨Ø§ ØªØ®ØªÙ‡ ======
function cellClick(i){
    if(!gameActive) return;
    if(board[i]!=="") return;
    
    playSound('move');
    
    if(gameMode==="single"){
        if(myTurn){ 
            board[i]=player.symbol; 
            myTurn=false; 
            updateBoard(); 
            document.getElementById('turnMsg').textContent = "Ù†ÙˆØ¨Øª Ø±Ø¨Ø§Øª...";
            let winner = checkWinner(board); 
            if(!winner) {
                setTimeout(robotMove,800);
            } else {
                handleWinner(winner);
            }
        }
    } else if(gameMode==="two"){
        board[i]=currentSymbol; 
        updateBoard(); 
        let winner = checkWinner(board);
        if(winner) {
            handleWinner(winner);
        } else {
            currentSymbol=currentSymbol==="X"?"O":"X";
            document.getElementById('turnMsg').textContent = `Ù†ÙˆØ¨Øª Ø¨Ø§Ø²ÛŒÚ©Ù† ${currentSymbol === "X" ? "âŒ" : "â­•"}`;
        }
    }
}

// ====== Ø­Ø±Ú©Øª Ø±Ø¨Ø§Øª ======
function robotMove(){
    if(!gameActive) return;
    
    const empty = board.map((v,i)=>v===""?i:-1).filter(v=>v!==-1);
    if(empty.length===0) return;
    
    let move = -1;
    const difficulty = player.settings.difficulty;
    
    if(difficulty === "hard") {
        move = findBestMove();
    } else if(difficulty === "medium") {
        // 70% Ø´Ø§Ù†Ø³ Ø­Ø±Ú©Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ØŒ 30% Ø´Ø§Ù†Ø³ Ø­Ø±Ú©Øª ØªØµØ§Ø¯ÙÛŒ
        if(Math.random() < 0.7) {
            move = findWinningMove("O") || findWinningMove("X");
        }
        if(move === -1) {
            move = findStrategicMove();
        }
    } else {
        // Ø³Ø·Ø­ Ø¢Ø³Ø§Ù† - Ø¨ÛŒØ´ØªØ± Ø­Ø±Ú©Ø§Øª ØªØµØ§Ø¯ÙÛŒ
        if(Math.random() < 0.3) {
            move = findWinningMove("O") || findWinningMove("X");
        }
        if(move === -1) {
            move = empty[Math.floor(Math.random()*empty.length)];
        }
    }
    
    if(move === -1) {
        move = empty[Math.floor(Math.random()*empty.length)];
    }
    
    setTimeout(() => {
        board[move] = "O";
        myTurn = true;
        updateBoard();
        document.getElementById('turnMsg').textContent = "Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª!";
        
        const winner = checkWinner(board);
        if(winner) handleWinner(winner);
    }, 1000);
}

function findBestMove() {
    // Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø­Ø±Ú©Ø§Øª
    const priorities = [4, 0, 2, 6, 8, 1, 3, 5, 7]; // Ù…Ø±Ú©Ø²ØŒ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ØŒ Ø³Ù¾Ø³ Ù„Ø¨Ù‡â€ŒÙ‡Ø§
    
    // Ø§ÙˆÙ„ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù†
    let move = findWinningMove("O");
    if(move !== -1) return move;
    
    // Ø³Ù¾Ø³ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù† Ø­Ø±ÛŒÙ
    move = findWinningMove("X");
    if(move !== -1) return move;
    
    // Ø³Ù¾Ø³ Ø­Ø±Ú©Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©
    for(let pos of priorities) {
        if(board[pos] === "") return pos;
    }
    
    return -1;
}

function findStrategicMove() {
    const centerAndCorners = [4, 0, 2, 6, 8].filter(index => board[index] === "");
    if(centerAndCorners.length > 0) {
        return centerAndCorners[Math.floor(Math.random() * centerAndCorners.length)];
    }
    return -1;
}

function findWinningMove(symbol){
    for(let i=0;i<9;i++){
        if(board[i]===""){
            board[i]=symbol;
            const winner = checkWinner(board);
            board[i]="";
            if(winner && winner.winner === symbol){
                return i;
            }
        }
    }
    return -1;
}

// ====== Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ ======
function restartSameGame(){
    // Ù„ØºÙˆ ØªØ§ÛŒÙ…Ø± Ù†ØªÛŒØ¬Ù‡
    if(resultTimeout) {
        clearTimeout(resultTimeout);
        resultTimeout = null;
    }
    
    board=["","","","","","","","",""];
    winningCombination = [];
    document.getElementById('resultOverlay').style.display = 'none';
    
    if(gameMode === "single"){
        myTurn = true;
        player.games.single.total++;
        document.getElementById('turnMsg').textContent = "Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª! (Ø´Ù…Ø§ âŒ Ù‡Ø³ØªÛŒØ¯)";
    } else if(gameMode === "two"){
        currentSymbol = "X";
        player.games.twoPlayer.total++;
        document.getElementById('turnMsg').textContent = `Ù†ÙˆØ¨Øª Ø¨Ø§Ø²ÛŒÚ©Ù† âŒ`;
    }
    
    createBoard();
    updateBoard();
    startGameTimer();
}

// ====== Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ======
window.onload = function() {
    const savedName = localStorage.getItem('playerName');
    if(savedName) {
        player.name = savedName;
        document.getElementById('playerName').value = savedName;
        loadPlayerData();
        showPage('mainMenu');
    } else {
        showPage('lobby');
    }
    
    createBoard();
    updateLeaderboardDisplay();
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² service worker Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†
    if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
    }
}

// Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡
window.addEventListener('beforeunload', function(){
    savePlayerData();
});
</script>
</body>
</html>