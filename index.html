<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Snake — موبایل</title>
<style>
  :root{
    --bg-white: #ffffff;
    --turquoise: #2bc4c4; /* فیروزه‌ای */
    --cream: #f3e7cf;     /* کرم/بیژ */
    --accent-dark: #0a6b6b;
    --food-red: #e23b3b;
    --bonus-yellow: #ffd24d;
    --shadow: rgba(0,0,0,0.12);
  }
  html,body{height:100%;margin:0;background:var(--bg-white);font-family:IRANSans,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; -webkit-tap-highlight-color: transparent;}
  #app{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:8px;padding:10px;box-sizing:border-box}
  #hud{width:100%;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 8px;border-radius:12px;background:linear-gradient(180deg,rgba(43,196,196,0.12),rgba(10,107,107,0.04));box-shadow:0 6px 18px var(--shadow)}
  #title{font-weight:700;color:var(--accent-dark);font-size:18px}
  #scoreBox{font-weight:700;color:var(--accent-dark);font-size:16px}
  #canvasWrap{flex:1;display:flex;align-items:center;justify-content:center;width:100%}
  canvas{width:100%;height:auto;max-width:420px;border-radius:14px;background:linear-gradient(180deg,#f9ffff, #eafdfd);box-shadow:0 10px 30px rgba(43,196,196,0.12);image-rendering:optimizeSpeed;touch-action:none}
  /* small footer */
  #note{font-size:12px;color:#6b6b6b;margin-top:6px}
  /* hint for swipe */
  .swipe-hint{font-size:13px;color:var(--accent-dark);opacity:0.8}
</style>
</head>
<body>
<div id="app">
  <div id="hud" role="region" aria-label="نوار امتیاز">
    <div id="title">Snake — نوستالژی</div>
    <div id="scoreBox">امتیاز: <span id="score">0</span>  |  بهترین: <span id="best">0</span></div>
  </div>

  <div id="canvasWrap">
    <canvas id="game"></canvas>
  </div>

  <div id="note" class="swipe-hint">سوایپ کن برای حرکت • مار بیضی‌شکل با چشم و خط‌های بدن • غذا: توپ قرمز</div>
</div>

<script>
/* ---------- تنظیمات بازی ---------- */
const GRID = 18;                     // اندازه یک خانه (px در اندازه‌بندی داخلی) — تنظیم‌پذیر
const BASE_SPEED_MS = 220;           // سرعت پایه (بزرگتر = کندتر) — تو خواستی کندتر
const BONUS_CHANCE = 0.35;           // شانس ظاهر شدن جایزه بعد از خوردن غذا
const BONUS_DURATION_TICKS = 80;     // مدت زنده بودن جایزه (تیک‌ها)
const CANVAS_MARGIN = 20;

/* ---------- وضعیت ---------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', {alpha:false});
let deviceW = Math.min(window.innerWidth - 20, 420);
let deviceH = window.innerHeight - 140;
if(deviceH > deviceW * 2) deviceH = Math.floor(deviceW * 1.6);

canvas.width = deviceW;
canvas.height = deviceH;

let cellW = Math.floor(canvas.width / GRID);
let cellH = Math.floor(canvas.height / GRID);
let cols = Math.floor(canvas.width / cellW);
let rows = Math.floor(canvas.height / cellH);

/* بازی */
let snake = [{x: Math.floor(cols/2), y: Math.floor(rows/2)}];
let dir = {x:1, y:0}; // ابتدا به راست
let nextDir = null;
let food = randomCell();
let bonus = null;
let bonusTimer = 0;
let score = 0;
let best = Number(localStorage.getItem('snake_best_v2') || 0);
document.getElementById('best').textContent = best;
document.getElementById('score').textContent = score;
let running = true;

/* سرعت — می‌توان بر اساس طول مار یا امتیاز کمی کاهش داد */
let tickMs = BASE_SPEED_MS;

/* ---------- صداهای ساده با WebAudio (اختیاری) ---------- */
let audioCtx = null;
function playTone(freq, dur=0.06, type='sine', vol=0.08){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  }catch(e){}
}

/* ---------- توابع کمکی ---------- */
function randomCell(){
  return { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
}
function cellsEqual(a,b){ return a.x===b.x && a.y===b.y; }

/* ---------- لمس / سوایپ ---------- */
let touchStartX=0, touchStartY=0;
canvas.addEventListener('touchstart', e=>{
  const t = e.touches[0];
  touchStartX = t.clientX; touchStartY = t.clientY;
});
canvas.addEventListener('touchmove', e=>{
  if(!touchStartX) return;
  const t = e.touches[0];
  const dx = t.clientX - touchStartX;
  const dy = t.clientY - touchStartY;
  const absx = Math.abs(dx), absy = Math.abs(dy);
  if(Math.max(absx,absy) < 12) return;
  if(absx > absy){
    // افقی
    if(dx > 0 && dir.x !== -1) nextDir = {x:1,y:0};
    else if(dx < 0 && dir.x !== 1) nextDir = {x:-1,y:0};
  } else {
    // عمودی
    if(dy > 0 && dir.y !== -1) nextDir = {x:0,y:1};
    else if(dy < 0 && dir.y !== 1) nextDir = {x:0,y:-1};
  }
  // برای جلوگیری از چند جهته شدن، ریست شروع
  touchStartX = t.clientX; touchStartY = t.clientY;
  e.preventDefault();
}, {passive:false});

/* کیبورد برای دسکتاپ */
window.addEventListener('keydown', e=>{
  if(e.key === 'ArrowLeft' && dir.x !== 1) nextDir = {x:-1,y:0};
  if(e.key === 'ArrowRight' && dir.x !== -1) nextDir = {x:1,y:0};
  if(e.key === 'ArrowUp' && dir.y !== 1) nextDir = {x:0,y:-1};
  if(e.key === 'ArrowDown' && dir.y !== -1) nextDir = {x:0,y:1};
});

/* ---------- منطق بازی ---------- */
function step(){
  if(!running) return;

  // اعمال جهت بعدی (اگر وجود داشته باشه)
  if(nextDir){ dir = nextDir; nextDir = null; }

  // سر جدید
  const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

  // عبور از دیواره ها (wrap around) — شبیه نوکیا
  if(head.x < 0) head.x = cols - 1;
  if(head.x >= cols) head.x = 0;
  if(head.y < 0) head.y = rows - 1;
  if(head.y >= rows) head.y = 0;

  // برخورد با خود
  for(let i=0;i<snake.length;i++){
    if(cellsEqual(head, snake[i])){
      // باخت -> ریست
      playTone(160, 0.18, 'sawtooth');
      gameOver();
      return;
    }
  }

  snake.unshift(head);

  // خوردن غذا
  if(cellsEqual(head, food)){
    score += 1;
    document.getElementById('score').textContent = score;
    playTone(900, 0.06, 'sine');
    // جایزه ممکنه ظاهر بشه
    if(Math.random() < BONUS_CHANCE){
      bonus = randomCell();
      // اجتناب از تداخل با مار یا غذا
      while(snake.some(s => cellsEqual(s, bonus)) || cellsEqual(bonus, food)){
        bonus = randomCell();
      }
      bonusTimer = BONUS_DURATION_TICKS;
    }
    // جای غذای بعدی
    food = randomCell();
    while(snake.some(s => cellsEqual(s, food)) || (bonus && cellsEqual(food, bonus))){
      food = randomCell();
    }
    // کمی کم کردن سرعت با افزایش طول نه — (نمیخوایم خیلی سخت شه)؛ سرعت حفظ میشه
  } else {
    // اگر غذا نخورده، بدن کوتاه میشه (حرکت)، اما اگر جایزه خورده باشه، همون رو اضافه کن
    snake.pop();
  }

  // خوردن جایزه
  if(bonus && cellsEqual(head, bonus)){
    score += 5;
    document.getElementById('score').textContent = score;
    bonus = null;
    bonusTimer = 0;
    playTone(1200, 0.08, 'triangle', 0.12);
  }

  // زمان جایزه کاهش پیدا کنه
  if(bonus){
    bonusTimer--;
    if(bonusTimer <= 0) bonus = null;
  }
}

/* ---------- پایان / ریست بازی ---------- */
function gameOver(){
  // ذخیره بهترین رکورد
  if(score > best){
    best = score;
    localStorage.setItem('snake_best_v2', String(best));
    document.getElementById('best').textContent = best;
  }
  // افکت کوتاه و ریست
  setTimeout(()=> {
    score = 0;
    document.getElementById('score').textContent = score;
    snake = [{x: Math.floor(cols/2), y: Math.floor(rows/2)}];
    dir = {x:1,y:0};
    nextDir = null;
    food = randomCell();
    bonus = null;
    bonusTimer = 0;
  }, 220);
}

/* ---------- رندر گرافیکی بهتر ---------- */
/* ترسیم مار به صورت بیضی‌هایی با خطوط بدن و چشم کوچک */
function render(){
  // پس‌زمینه تم سفید-فیروزه‌ای ملایم با گرادیان
  ctx.fillStyle = '#f9ffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // یک قاب داخلی فیروزه ای کم‌رنگ
  ctx.strokeStyle = 'rgba(43,196,196,0.18)';
  ctx.lineWidth = 6;
  roundRect(ctx, 6, 6, canvas.width-12, canvas.height-12, 14);
  ctx.stroke();

  // شبکه (اختیاری سبک)
  // draw grid very subtly
  ctx.strokeStyle = 'rgba(10,107,107,0.03)';
  ctx.lineWidth = 1;
  for(let i=0;i<=cols;i++){
    const x = i * cellW;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
  }
  for(let j=0;j<=rows;j++){
    const y = j * cellH;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
  }

  // ترسیم غذا = توپ قرمز براق
  drawFood(food.x, food.y);

  // ترسیم جایزه (اگر وجود داره) — مربع زرد با درخشش
  if(bonus){
    drawBonus(bonus.x, bonus.y);
  }

  // ترسیم مار — بچه‌ها: از دم به سر طوسی/کرمی
  for(let i = snake.length - 1; i >= 0; i--){
    const p = snake[i];
    const px = p.x * cellW + cellW/2;
    const py = p.y * cellH + cellH/2;
    const w = Math.max(cellW * 0.9 - i*0.02, cellW * 0.76);
    const h = Math.max(cellH * 0.9 - i*0.02, cellH * 0.6);

    // رنگ پایه کرم و سایه خیلی کم
    ctx.save();
    // کمی گرادینت برای حجم
    const grad = ctx.createLinearGradient(px - w/2, py - h/2, px + w/2, py + h/2);
    grad.addColorStop(0, '#fff7eb');
    grad.addColorStop(0.6, '#f3e7cf');
    grad.addColorStop(1, '#e7d9bf');
    ctx.fillStyle = grad;
    roundEllipse(ctx, px, py, w*0.5, h*0.5);
    ctx.fill();

    // خطوط روی بدن: چند خط نازک تیره‌تر (برای قسمت‌های جلوتر رسمش واضح‌تر)
    ctx.strokeStyle = 'rgba(160,132,92,0.45)';
    ctx.lineWidth = Math.max(1, Math.min(2.2, w*0.03));
    const stripes = 2;
    for(let s=0;s<stripes;s++){
      const ox = px - w*0.18 + s*(w*0.18);
      ctx.beginPath();
      ctx.ellipse(ox, py, w*0.22, h*0.28, -0.2 + s*0.12, 0, Math.PI*2);
      ctx.stroke();
    }

    // چشم کوچک فقط برای سر (i===0)
    if(i === 0){
      // موقعیت چشم در گوشه سمت راست نسبت به جهت حرکت
      let ex = px + (dir.x === 1 ? w*0.22 : dir.x === -1 ? -w*0.22 : 0);
      let ey = py + (dir.y === 1 ? h*0.22 : dir.y === -1 ? -h*0.22 : 0);
      // برای حالت افقی که چشم باید بالا/پایین کمی اصلاح کن
      if(dir.x !== 0 && dir.y === 0){
        ey = py - Math.min(h*0.14, 4);
      }
      ctx.fillStyle = '#111'; // چشم نقطه ریز
      ctx.beginPath(); ctx.arc(ex, ey, Math.max(1.6, w*0.06), 0, Math.PI*2); ctx.fill();
    }

    ctx.restore();
  }

  // جلوه HUD (نیم شفاف) با گوشه‌ها
  // (امتیاز در بالا مستقل است، نیازی نیست داخل canvas هم چاپ کنیم)
}

/* helper: رسم بیضی-rounded */
function roundEllipse(ctx, cx, cy, rx, ry){
  ctx.beginPath();
  ctx.ellipse(cx, cy, Math.max(1,rx), Math.max(1,ry), 0, 0, Math.PI*2);
  ctx.closePath();
}

/* helper: rounded rect */
function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

/* draw food (red shiny ball) */
function drawFood(cxCell, cyCell){
  const cx = cxCell * cellW + cellW/2;
  const cy = cyCell * cellH + cellH/2;
  const r = Math.min(cellW, cellH) * 0.42;

  // glow
  ctx.save();
  const g = ctx.createRadialGradient(cx,cy, r*0.1, cx,cy, r*1.6);
  g.addColorStop(0, 'rgba(226,59,59,0.95)');
  g.addColorStop(0.6, 'rgba(226,59,59,0.95)');
  g.addColorStop(1, 'rgba(226,59,59,0.06)');
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.arc(cx,cy,r*1.2,0,Math.PI*2); ctx.fill();

  // ball
  const grad = ctx.createLinearGradient(cx - r, cy - r, cx + r, cy + r);
  grad.addColorStop(0, '#ff6b6b');
  grad.addColorStop(0.5, '#e23b3b');
  grad.addColorStop(1, '#b92a2a');
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();

  // highlight
  ctx.fillStyle = 'rgba(255,255,255,0.45)';
  ctx.beginPath();
  ctx.ellipse(cx - r*0.32, cy - r*0.45, r*0.22, r*0.14, -0.3, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();
}

/* draw bonus (yellow) */
function drawBonus(cxCell, cyCell){
  const cx = cxCell * cellW + cellW/2;
  const cy = cyCell * cellH + cellH/2;
  const s = Math.min(cellW, cellH) * 0.6;

  ctx.save();
  ctx.fillStyle = '#ffd24d';
  ctx.beginPath();
  ctx.roundRect
  // draw small rounded square (star-like)
  roundRect(ctx, cx - s/2, cy - s/2, s, s, s*0.22);
  ctx.fill();

  // glow
  ctx.globalAlpha = 0.12;
  ctx.fillStyle = '#ffd24d';
  ctx.beginPath(); ctx.arc(cx, cy, s*0.9, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;
  ctx.restore();
}

/* ---------- لوپ اصلی ---------- */
let lastTick = performance.now();
function loop(now){
  const elapsed = now - lastTick;
  if(elapsed >= tickMs){
    step();
    render();
    lastTick = now;
  }
  requestAnimationFrame(loop);
}

/* ---------- init ---------- */
render();
requestAnimationFrame(loop);

/* ---------- ذخیره خودکار بهترین هنگام ترک صفحه ---------- */
window.addEventListener('beforeunload', ()=>{
  if(score > best) localStorage.setItem('snake_best_v2', String(score));
});

/* سازگاری: وقتی پنجره تغییر سایز داد، اندازه‌ها را بازتنظیم می‌کنیم */
window.addEventListener('resize', ()=>{
  // برای سادگی صفحه رو ری‌لود می‌کنیم تا همه چیز صحیح فیت شه
  // (این ساده‌ترین راه برای موبایل و تغییر جهت است)
  setTimeout(()=> location.reload(), 150);
});

/* ---------- Polyfill: context.roundRect برای برخی مرورگرها (اختیاری) ---------- */
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    r = r || 6;
    const rr = Math.min(r,w/2,h/2);
    this.beginPath();
    this.moveTo(x+rr,y);
    this.arcTo(x+w,y,x+w,y+h,rr);
    this.arcTo(x+w,y+h,x,y+h,rr);
    this.arcTo(x,y+h,x,y,rr);
    this.arcTo(x,y,x+w,y,rr);
    this.closePath();
  };
}

/* ---------- پایان کد ---------- */
</script>
</body>
    </html>
